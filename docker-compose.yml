services:
  # OTLP Collector for integration testing
  otel-collector:
    image: otel/opentelemetry-collector:latest
    container_name: telemetry-otel-collector
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./docker/otel-collector-config.yaml:/etc/otel/config.yaml:ro
    ports:
      - "4317:4317"   # gRPC
      - "4318:4318"   # HTTP
    networks:
      - telemetry

  # PHP with Swoole for running tests
  # Usage: docker compose run --rm php composer test
  php:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/app
      - composer-cache:/root/.composer/cache
    working_dir: /app
    depends_on:
      - otel-collector
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    networks:
      - telemetry

networks:
  telemetry:

volumes:
  composer-cache:
